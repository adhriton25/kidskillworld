datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

// -----------------------------------------------------------------------------
// 0. User (Authentication)
// -----------------------------------------------------------------------------
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name    String
  passwordHash String?  // nullable for OAuth users in future
  isSubscribed  Boolean   @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  resetTokens PasswordResetToken[]
}

model PasswordResetToken {
  token     String   @id
  userId    String
  expires   DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// -----------------------------------------------------------------------------
// 1. Grade
// -----------------------------------------------------------------------------
model Grade {
  id         Int         @id @default(autoincrement())
  name       String      @unique
  skills     Skill[]
  worksheets Worksheet[]

  @@index([name])
}

// -----------------------------------------------------------------------------
// 2. Subject
// -----------------------------------------------------------------------------
model Subject {
  id         Int         @id @default(autoincrement())
  name       String      @unique
  skills     Skill[]
  worksheets Worksheet[]

  @@index([name])
}

// -----------------------------------------------------------------------------
// 3. Skill Category
// -----------------------------------------------------------------------------
model SkillCategory {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  skills Skill[]
}

// -----------------------------------------------------------------------------
// 4. Skill
// -----------------------------------------------------------------------------
model Skill {
  id              Int              @id @default(autoincrement())
  name            String
  description     String?

  gradeId         Int
  subjectId       Int
  categoryId      Int

  grade           Grade            @relation(fields: [gradeId], references: [id])
  subject         Subject          @relation(fields: [subjectId], references: [id])
  category        SkillCategory    @relation(fields: [categoryId], references: [id])

  topics          Topic[]
  worksheetSkills WorksheetSkill[]

  @@unique([name, gradeId, subjectId], name: "name_gradeId_subjectId")
  @@index([gradeId, subjectId])
}

// -----------------------------------------------------------------------------
// 5. Topic
// -----------------------------------------------------------------------------
model Topic {
  id      Int             @id @default(autoincrement())
  name    String
  skillId Int

  skill   Skill           @relation(fields: [skillId], references: [id])
  papers  PracticePaper[]

  @@unique([name, skillId])
}

// -----------------------------------------------------------------------------
// 6. Practice Paper
// -----------------------------------------------------------------------------
model PracticePaper {
  id      Int    @id @default(autoincrement())
  title   String
  pdfUrl  String
  topicId Int

  topic   Topic  @relation(fields: [topicId], references: [id])
}

// -----------------------------------------------------------------------------
// 7. Worksheet
// -----------------------------------------------------------------------------
model Worksheet {
  id              Int              @id @default(autoincrement())
  title           String
  description     String
  pdfUrl          String
  gradeId         Int
  subjectId       Int
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  grade           Grade            @relation(fields: [gradeId], references: [id])
  subject         Subject          @relation(fields: [subjectId], references: [id])
  worksheetSkills WorksheetSkill[]

  @@index([gradeId])
  @@index([subjectId])
}

// -----------------------------------------------------------------------------
// 8. WorksheetSkill
// -----------------------------------------------------------------------------
model WorksheetSkill {
  id          Int       @id @default(autoincrement())
  worksheetId Int
  skillId     Int

  worksheet   Worksheet @relation(fields: [worksheetId], references: [id])
  skill       Skill     @relation(fields: [skillId], references: [id])

  @@unique([worksheetId, skillId])
}
